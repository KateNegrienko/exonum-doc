# Сервис анкоринга

<!-- cspell:ignore bitcoind,blockhash,lects,satoshis,txid,utxo,utxos -->

Сервис анкоринга разработан для повышения безопасности продукта и обеспечения
отказоустойчивости приложений Exonum. Этот сервис периодически публикует хеш
блока блокчейна Exonum в Биткоин блокчейн, чтобы любой, кто имеет доступ к
блокчейну Exonum, имел возможность его проверить. Даже в случае сговора
валидаторов историю транзакций не возможно сфальсифицировать. Несоответствие
между фактическим состоянием блокчейна Exonum и тем, которое записано в Биткоин
блокчейн, будет мгновенно обнаружено.

!!! note "Примечание"
    Данный документ в основном описывает принцип работы сервиса. Описание
    [процесса настройки и развертывания][anchoring-deploy] сервиса представлено
    в отдельном документе, исходный код которого находится на [GitHub][github-anchoring].

## Общий принцип

Сервис записывает хеш последнего блока Exonum в постоянное хранилище, доступное
каждому только для чтения. Такой блок называется _анкорящим блоком_, а его
хеш _анкорящим хешем_.

Сервис создает _анкорящую цепочку_ поверх Биткоин блокчейна, другими словами,
цепочка состоит из множества _анкорящих транзакций Биткоина_. Каждая анкорящая
транзакция имеет как минимум 1 вход и только 2 выхода: выход данных и выход
остатка баланса. Выход данных содержит сохраненный анкорящий хеш, в то время
как выход остатка баланса возвращает оставшиеся деньги на адрес Биткоин
анкоринга, чтобы они могли быть ипользованы для осуществления следующей
анкорящей транзакции.

```None
             пополнение
             баланса tx
                        \
      tx1        tx2     \   tx3        tx4
.. --> остаток --> остаток --> остаток --> остаток --> ..
   \           \           \           \
    -> данные   -> данные   -> данные   -> данные
```

Иногда используются дополнительные входы, называемые непотраченными выходами
транзакции для пополнения баланса ([UTXO пополнения баланса](https://exonum.com/doc/advanced/bitcoin-anchoring/#funding-utxo)).
Такие входы необходимы для пополнения баланса анкорящей цепочки, который
расходуется на комиссию для осуществления транзакций.

## Анкорящие транзакции

### Multisig-адрес как метод децентрализации

Децентрализация в процессе анкоринга построена на внутренней архитектуре адресов
Биткоин с множественными подписями (multisig-адреса).

В момент, когда сеть Exonum должна быть заанкорена, каждый валидатор строит
анкорящую транзакцию с использованием
[строго определенного алгоритма](#создание-анкорящей-транзакции).
Его результаты гарантировано совпадут для каждого честного валидатора. Эта
анкорящая транзакция тратит один или несколько UTXO из текущего анкорящего
multisig-адреса. Каждый валидатор может подписать эту транзакцию без учета
других валидаторов, поскольку это допускается сетью Биткоин. Все подписи
публикуются в блокчейне Exonum.

Exonum использует multisig-адреса `M из N`, где `N` - число анкорящих
валидаторов  (`N <= 20` из-за ограничений в сети Биткоин), а `M` - необходимое
количество подписей. В консенсусе Exonum `M = floor(2/3*N) + 1` используется как
абсолютное большинство.

!!! note "Примечание"
    Допустим имеется `N=10` валидаторов, тогда `M=7` представляет собой
    абсолютное большинство. Это означает, что для создания анкорящей транзакции
    требуется 7 подписей. Если же `N=4`, то требуется `M=3` подписей.

После публикации необходимого количества подписей любой узел-участник может
создать правильную и подписанную анкорящую транзакцию и передать ее в
Биткоин блокчейн.

### Изменяемость транзакций

Подписи валидаторов записаны в блокчейне Exonum в открытом виде; при этом может
быть опубликовано более `M` подписей (достаточно частое явление).
Существует отдельный алгоритм, который строго определенным образом из них
отбирает `М` подписей. Если же все валидаторы являются честными, некоторые
транзакции базируются на единственно возможном при этом полном списке подписей.

Однако любой византийский узел может отклониться от детерминированного алгоритма
и использовать другой список подписей для анкорящей транзакции. Этот узел может
создать транзакцию с тем же анкорящим хешем (тот же вывод данных), но с другим
ID транзакции (tx-id), и передать его в сеть Биткоин. Такие нестандартные
транзакции представляют собой проблему, потому что новые анкорящие транзакции
могут формироваться, даже если более старые транзакции еще не были включены в
Биткоин блокчейн. При этом есть вероятность, что более старая транзакция или
один из ее предков были мутированы византийским валидатором, как описано выше, и
мутировавшая транзакция была записана в Биткоин блокчейн. При таких условиях
исходная транзакция становится некорректной и более не может быть включена в
Биткоин блокчейн.

Для разрешения этой проблемы, выбор соответствующей предыдущей транзакции
[LECT](#lect) происходит на основе консенсуса.

### LECT

Каждый валидатор определяет, какая анкорящая транзакция считается крайней. Эта
транзакция должна быть потрачена в новой анкорящей транзакции и называется
крайней ожидаемой корректной транзакцией (LECT). LECT всех валидаторов
публикуются в блокчейне Exonum. При создании новой анкорящей транзакции
абсолютное большинство валидаторов выбирает общий LECT и тратит его выход
остатка баланса.

Каждый валидатор обновляет свой LECT по [специальному расписанию](https://exonum.com/doc/advanced/bitcoin-anchoring/#lect-updating-interval).
Чтобы получить новый LECT, валидатор использует API [узла Биткоина](https://exonum.com/doc/advanced/bitcoin-anchoring/#bitcoind-node).
Новый LECT должен обладать следующими свойствами:

- Это действительная анкорящая транзакция для текущего блокчейна Exonum;
- Он может иметь любое количество подтверждений, в частности, 0;
- Его выход остатка баланса должен быть неизрасходованным. Это означает, что
  указанный валидатор считает, что после данного LECT не было других анкорящих
  транзакций;
- Среди всех Биткоин транзакций, удовлетворяющих выше перечисленным свойствам,
  LECT должен иметь наибольшую высоту анкорящего блока блокчейна Exonum;
- Если несколько транзакций соответствуют предыдущим требованиям, любая из них
  может быть выбрана как LECT.

LECT решает проблему изменяемости транзакций, хотя иногда встречаются и
осиротевшие анкорящие транзакции, которые никогда не будут записаны в Биткоин
блокчейн. Тем не менее, эта система достаточно безопасна, поскольку последующие
анкорящие транзакции в действительности анкорят и все предыдущие (т.к. хеш блока
более поздней анкорящей транзакции зависит от хеша блока осиротевшей
транзакции).

Exonum использует [`bitcoind` клиент](https://exonum.com/doc/advanced/bitcoin-anchoring/#bitcoind-node),
и только одна из транзакций, соответствующих требованиям, может считаться
действительной bitcoind узлом.

### Детальная структура предложения анкорящей транзакции

  Предложение анкорящей транзакции строится следующим образом:

  - Оно соответствует спецификации Биткоин транзакции.
  - Его входы включают в себя:

     - Выход остатка баланса общего выбранного LECT. Этот вход присутствует в
     каждой анкорящей транзакции, кроме первой.
     - UTXO пополнения баланса, записанный в глобальной конфигурации (если он
     еще не потрачен).

  - Его выходы содержат вывод данных и выход остатка баланса. Сначала идет выход
    остатка баланса, а следом - вывод данных.
  - Его вывод данных содержит одну инструкцию `OP_RETURN` с анкорящими данными.
    Такие данные состоят из множественных [фрагментов данных](#фрагменты-данных)
  - Его выход остатка баланса перенаправляет средства на следующий анкорящий
    адрес, если анкорящий адрес [должен быть изменен](https://exonum.com/doc/advanced/bitcoin-anchoring/#changing-validators-list).
    В противном случае используется текущий адрес.

### Фрагменты данных

Вывод данных состоит из следующих частей:

- инструкция OP_RETURN (`0x6a`)
- 1 байт, содержащий цифру, соответствующую длине данных в скрипте
- `EXONUM` в кодировке ASCII (`0x45 0x58 0x4f 0x4e 0x55 0x4d`)
- 1-байтная версия текущего вывода данных, в настоящее время `1`
- 1-байтовый тип полезной нагрузки: 0, если включен только анкорящий хеш, 1,
  если используются оба фрагмента
- 40 байт фрагмента данных анкорящего хеша
- (опционально) 32 байта восстанавливающего фрагмента данных

Все целочисленные фрагменты представлены в виде прямого порядка байт в
соответствии с общими принципами сценария Биткоин блокчейна.

В целом полезная нагрузка анкорящей транзакции обычно занимает 48 байт и
увеличивается до 80 байт при необходимости восстановления.

#### Фрагмент данных анкорящего хеша

- 8-байтовая беззнаковая высота анкорящего блока (то есть высота генезис-блока
  равна `0`), которая используется для эффективного поиска.
- 32-байтовый хеш блока

#### Фрагмент востанавливающих данных

Данные восстановливающего фрагмента - это 32-байтовый хеш Биткоин транзакции.
Этот хеш показывает, что текущая анкорящая цепь является продолжением ранее
прерванной анкорящей цепи. Возможные причины таких остановок описаны далее.

Восстановливающий фрагмент является необязательным и может отображаться в самой
первой анкорящей Биткоин транзакции только в случае, если предыдущая анкорящая
цепочка оборвалась (как описано в разделе [Восстановление предыдущей цепочки](https://exonum.com/doc/advanced/bitcoin-anchoring/#recovering-broken-anchoring)).

### Создание анкорящей транзакции

- Допустим, `H` - высота блока, который должен быть заанкорен
- Начиная с этого блока `#H`, каждый валидатор контролирует список текущих LECT.
  Как только появляется общий LECT (который определяется `+2/3` валидаторов),
  **предложение анкорящей транзакции** (анкорящая транзакция без подписей
  валидаторов) считается полностью определенной и согласовывается `+2/3`
  валидаторов.
- После появления общего LECT, каждый валидатор строит анкорящую транзакцию и
  подписывает каждый ее вход
- Подписи публикуются в блокчейне Exonum
- На основе подписей _любой_ узел Exonum может создавать анкорящую транзакцию
  и транслировать ее в сеть Биткоин. В частности, она транслируется всеми
  валидаторами, которые согласились с выбранным LECT.

#### Пропуск анкоринга

Если подошло время блокчейну Exonum выполнить анкоринг, но LECT не согласован с
`+2/3` валидаторов, то анкоринг не выполняется. Сервис анкоринга ждет, пока
некоторые валидаторы не обновят свою анкорящую цепочку, и общий LECT не будет
обнаружен. Новый блок для анкоринга - это крайний блок блокчейна Exonum, который
должен быть заанкорен. Например, блокчейн Exonum находится на высоте `#11000` с
интервалом привязки `1000` блоков. Если общий LECT появляется на высоте
`#12345`, блок `#12000` анкорится, хотя для блока `#11000` анкоринг не
состоится.

[anchoring-deploy]: https://github.com/exonum/exonum-btc-anchoring/blob/master/DEPLOY.md
[anchoring-parameters]: https://github.com/exonum/exonum-btc-anchoring/blob/master/DEPLOY.md#change-configuration-parameters
[github-anchoring]: https://github.com/exonum/exonum-btc-anchoring
[bitcoind]: https://bitcoin.org/en/bitcoin-core/
